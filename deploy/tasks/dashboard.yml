- name: Create checkout directory
  become: yes
  file:
    path: "{{deploy_directory}}"
    state: directory
    owner: pi
    group: pi

- name: Get current git branch
  command: git branch --show-current
  register: git_branch_out
  delegate_to: 127.0.0.1

- debug:
    var: git_branch_out

- name: Get latest dashboard code
  git:
    repo: git@github.com:dandezille/leo-dashboard.git
    dest: "{{deploy_directory}}"
    version: "{{git_branch_out.stdout}}"
    force: yes
    accept_hostkey: yes
  register: checkout

- name: Copy .env file
  copy:
    src: ../.env
    dest: "{{deploy_directory}}"

- name: Precompile assets
  command: docker-compose run rails rails assets:precompile
  args:
    chdir: "{{deploy_directory}}" 
  register: assets_out

- debug:
    var: assets_out

- name: Start with docker compose
  docker_compose:
    project_src: "{{deploy_directory}}"
    build: yes
    remove_orphans: yes
  vars:
    ansible_python_interpreter: /usr/bin/python3
  environment:
    RAILS_ENV: production
  notify: refresh browser

- name: Clean assets
  command: docker-compose run rails rails assets:clean
  args:
    chdir: "{{deploy_directory}}" 
  register: assets_out

- debug:
    var: assets_out

- debug:
    var: docker_prune_out
